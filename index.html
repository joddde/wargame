<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Text‑Based Game – Type Sound</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0; padding: 24px;
      font: 16px/1.45 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #0b0f14; color: #d6e2f0;
    }
    h1 { font-size: 16px; margin: 0 0 12px; color: #8fb3ff; }
    .frame {
      border: 1px solid #2b3a4a; border-radius: 8px; padding: 16px; background: #0e121a;
      box-shadow: 0 0 0 1px #0e121a inset, 0 6px 24px rgba(0,0,0,.4);
    }
    #output {
      white-space: pre-wrap; /* keep your original newlines/formatting */
      font-size: 15px;
      letter-spacing: .2px;
      min-height: 8rem;
    }
    /* Example timer style (won't make sound due to .timer class) */
    .timer {
      margin-top: 12px; padding: 6px 8px; display: inline-block;
      background: #111620; color: #8bd7a5; border: 1px solid #1b2533; border-radius: 4px;
      font-weight: 600;
    }
    .hint {
      color: #7a8aa0; font-size: 13px; margin: 10px 0 0;
    }
  </style>
</head>
<body>
  <h1>Text‑Based Game</h1>
  <div class="frame">
    <div id="output" aria-live="polite" aria-label="Rendered text output"></div>

    <!-- Example timer (silenced automatically) -->
    <div class="timer" id="countdown" aria-label="Countdown timer" data-silent="true">00:05</div>

    <div class="hint">Click anywhere to start the rendering & sound. Timers are silent.</div>
  </div>

  <script>
    /* ============================================================
       WebAudio click generator (no external audio file required)
       - Plays a short percussive click for each rendered character
       - Skips elements in .timer, .no-sound, or [data-silent="true"]
       ============================================================ */
    const TypeClick = (() => {
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();
      let enabled = false;
      let minGap = 28;     // ms between clicks (prevents audio spam)
      let lastAt = 0;

      // Unlock audio on first user gesture
      const unlock = () => { enabled = true; if (ctx.state === 'suspended') ctx.resume(); };
      window.addEventListener('pointerdown', unlock, { once: true });
      window.addEventListener('keydown', unlock, { once: true });

      function shouldSilenceFor(el) {
        return el && el.closest('.timer, .no-sound, [data-silent="true"]');
      }

      function click(forEl) {
        if (!enabled) return;
        if (shouldSilenceFor(forEl)) return;

        const now = performance.now();
        if (now - lastAt < minGap) return;
        lastAt = now;

        const t = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        // A sharp "key click": short square burst with envelope & slight downward sweep
        osc.type = 'square';
        osc.frequency.setValueAtTime(2400, t);
        osc.frequency.exponentialRampToValueAtTime(1600, t + 0.04);

        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.linearRampToValueAtTime(0.35, t + 0.002);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.045);

        osc.connect(gain).connect(ctx.destination);
        osc.start(t);
        osc.stop(t + 0.05);
      }

      return {
        play: click,
        setMinGap(ms) { minGap = Math.max(0, ms|0); }
      };
    })();

    /* ============================================================
       Type text into an element, playing a click for each character
       ============================================================ */
    async function typeWithSound(el, text, {
      charDelay = 45,   // ms between characters
      soundEvery = 1    // 1 = every char; 2 = every other char, etc.
    } = {}) {
      el.textContent = '';
      for (let i = 0; i < text.length; i++) {
        el.textContent += text[i];
        if (i % soundEvery === 0) TypeClick.play(el);
        await new Promise(r => setTimeout(r, charDelay));
      }
    }

    /* ============================================================
       OPTIONAL: Auto-sound for *any* incremental text rendering on
       the page via MutationObserver (skips timers automatically).
       Enable if you have your own typing logic elsewhere.
       ============================================================ */
    function attachTypingSound(root = document, {
      ignore = '.timer, .no-sound, [data-silent="true"]'
    } = {}) {
      const obs = new MutationObserver(muts => {
        for (const m of muts) {
          if (m.type === 'characterData') {
            const el = m.target.parentElement;
            if (el && !el.closest(ignore)) TypeClick.play(el);
          } else if (m.type === 'childList') {
            m.addedNodes.forEach(node => {
              if (node.nodeType === Node.TEXT_NODE) {
                const el = node.parentElement;
                if (el && !el.closest(ignore)) TypeClick.play(el);
              }
            });
          }
        }
      });
      obs.observe(root, { subtree: true, characterData: true, childList: true });
      return obs;
    }
    // If you already have your own renderer, uncomment the line below:
    // const stop = attachTypingSound();

    /* ============================================================
       Your original file content to render with sound
       (kept verbatim, including escapes and newlines)
       ============================================================ */
    const SOURCE_TEXT = `# Text\\-Based Game 
SYSTEM QUERY
× 
Cancel \\(Esc\\) OK \\(Enter\\) `;

    // Start: wait for a user gesture (audio policy), then type out
    const outputEl = document.getElementById('output');
    window.addEventListener('pointerdown', () => {
      // Begin typing once, on first interaction
      typeWithSound(outputEl, SOURCE_TEXT, { charDelay: 45, soundEvery: 1 });
    }, { once: true });

    /* ---- (Demo) Silent timer: updates without triggering clicks ---- */
    (function demoTimer() {
      const tEl = document.getElementById('countdown'); // marked data-silent + .timer
      let s = 5;
      const iid = setInterval(() => {
        s--;
        tEl.textContent = `00:0${s}`;
        if (s <= 0) { clearInterval(iid); tEl.textContent = '00:00'; }
      }, 1000);
    })();
  </script>
</body>
</html>
